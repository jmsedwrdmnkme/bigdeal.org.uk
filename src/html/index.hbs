<?php get_header(); ?>
<main id="content" class="my-n5 entry-content">
  <div class="full-width pt-5 text-center bg-indigo-offset">
    <div class="container">
      <h1 class="text-white"><?php single_post_title(); ?></h1>
      <?php
        $page_id = get_queried_object_id();
        if ( has_post_thumbnail( $page_id ) ) :
          $image_array = wp_get_attachment_image_src( get_post_thumbnail_id( $page_id ), 'large' );
          $image = $image_array[0];
          echo '<img src="'.$image.'" class="img-fluid mx-auto" loading="lazy" alt="" width="536" height="499">';
        endif;
      ?>
    </div>
  </div>

  <?php
    $personal_stories = get_post( 486 );
    $personal_stories_content = apply_filters('the_content', $personal_stories->post_content);
    echo $personal_stories_content;
  ?>
  <style>
    .bg-green-offset .wp-block-buttons { display: none; }
  </style>

  <?php
    $videos = get_post( 558 );
    $videos_content = apply_filters('the_content', $videos->post_content);
    echo $videos_content;
  ?>

  <div class="py-5">
    <h2 class="has-text-align-center">Blogs</h2>
    <div class="row" class="blog-posts">
      <?php if ( have_posts() ) : while ( have_posts() ) : the_post(); ?>
        <div class="col-md-6 col-lg-4 d-flex mb-3 post-wrapper">
          <article id="post-<?php the_ID(); ?>" <?php post_class(['class' => 'd-flex']); ?>>
            <div class="card p-3">
              <header>
                <?php if ( has_post_thumbnail() ) : ?>
                  <a href="<?php the_permalink(); ?>" title="<?php the_title_attribute(); ?>">
                    <?php the_post_thumbnail( array(532, 225), ['class' => 'img-fluid']); ?>
                  </a>
                <?php endif; ?>
                <a href="<?php the_permalink(); ?>" title="<?php the_title_attribute(); ?>" class="text-decoration-none" rel="bookmark">
                  <h3 class="entry-title my-3"><?php the_title(); ?></h3>
                </a>
              </header>
              <div class="mt-auto entry-summary">
                <?php
                  $excerpt = get_the_excerpt(); 
                  $excerpt = substr( $excerpt, 0, 105 );
                  $result = substr( $excerpt, 0, strrpos( $excerpt, ' ' ) );
                  echo $result;
                ?>
              </div>
              <a href="<?php the_permalink(); ?>" title="<?php the_title_attribute(); ?>" class="footer-link">Read more</a>
            </div>
          </article>
        </div>
      <?php endwhile; endif; ?>
      <div class="row" id="extra-posts"></div>
    </div>

    <div class="text-center pt-4" id="load-more-posts">
      <button class="btn btn-primary" type="button">Load More</button>
    </div>

    <?php $nonce = wp_create_nonce('extra-special'); ?>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      offset = 6;
      jQuery('#load-more-posts button').click(function() {
        var ajax_url = '/wp-admin/admin-ajax.php';
        var data = {
          'action': 'load_more_posts',
          'offset': offset,
          'security': '<?php echo $nonce; ?>',
        };

        jQuery.post(ajax_url, data, function(response) {
          if (response !== ''){
            jQuery('#extra-posts').append(response);
            offset += 6;
            jQuery('#extra-posts').css('opacity', '1');
          } else {
            jQuery('#load-more-posts').hide();
          }
        });
      });
    </script>
  </div>

  <div class="wp-block-group bg-green-offset"><div class="wp-block-group__inner-container">
    <h2 class="has-text-align-center">Personal stories</h2>
    <div class="wp-block-columns">
      <?php
        $args = array(
          'post_type' => 'personal_stories',
          'posts_per_page' => 2
        );
        $the_query = new WP_Query( $args );

        if ( $the_query->have_posts() ) : ?>
          <?php while ( $the_query->have_posts() ) : $the_query->the_post(); ?>
            <div class="wp-block-column card block-heading">
              <h3 class="display-2"><?php the_title(); ?></h3>
              <p><strong>Do I have a gambling problem?</strong></p>
              <p><?php the_excerpt(); ?></p>
              <p><a href="https://bigdeal.jamesmonk.me/index.php/news-and-stories/" data-type="page" data-id="28">Read Alexâ€™s story</a></p>
            </div>
          <?php endwhile; ?>

          <?php wp_reset_postdata();
        endif;
      ?>
    </div>
    <div class="wp-block-buttons is-content-justification-center">
      <div class="wp-block-button is-style-fill">
        <a class="wp-block-button__link" href="https://bigdeal.jamesmonk.me/index.php/news-and-stories/">See all stories</a></div>
      </div>
    </div>
  </div>

  <?php
    $footer_top = get_post( 298 );
    $footer_top_content = apply_filters('the_content', $footer_top->post_content);
    echo $footer_top_content;
  ?>
</main>
<?php get_footer(); ?>
